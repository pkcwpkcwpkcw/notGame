# Step 5: 게이트 배치 시스템 기능 명세서

## 1. 기능 개요

### 1.1 목적
사용자가 NOT 게이트를 그리드 캔버스에 배치, 선택, 삭제할 수 있는 인터랙티브한 회로 편집 기능을 제공한다.

### 1.2 주요 기능
- 게이트 팔레트를 통한 게이트 선택
- 그리드 기반 게이트 배치
- 게이트 선택 및 하이라이트
- 게이트 삭제
- 실시간 시각적 피드백

## 2. 사용자 인터페이스

### 2.1 게이트 팔레트

#### 2.1.1 위치 및 레이아웃
```
┌─────────────────────────────────────────┐
│  [도구 팔레트]                          │
│  ┌──────────┐                          │
│  │   NOT    │ ← 64x64px 버튼           │
│  │   Gate   │                          │
│  └──────────┘                          │
│                                        │
│  선택된 도구: NOT Gate                  │
│  단축키: N                              │
└─────────────────────────────────────────┘
```

#### 2.1.2 상호작용
- **클릭**: NOT 게이트 배치 모드 활성화
- **호버**: 툴팁 "NOT Gate - 입력 신호를 반전시킵니다"
- **선택 표시**: 선택시 버튼 하이라이트 (밝은 테두리)

### 2.2 게이트 배치 모드

#### 2.2.1 시각적 표현
```
그리드 캔버스:
┌─┬─┬─┬─┬─┬─┬─┬─┬─┐
├─┼─┼─┼─┼─┼─┼─┼─┼─┤
├─┼─┼─╔═╗─┼─┼─┼─┼─┤  ← 반투명 프리뷰
├─┼─┼─║N║─┼─┼─┼─┼─┤     (마우스 위치)
├─┼─┼─╚═╝─┼─┼─┼─┼─┤
├─┼─┼─┼─┼─┼─┼─┼─┼─┤
└─┴─┴─┴─┴─┴─┴─┴─┴─┘
```

#### 2.2.2 상태 표시
- **유효한 위치**: 초록색 반투명 오버레이
- **무효한 위치**: 빨간색 반투명 오버레이 + X 표시
- **점유된 위치**: 빨간색 격자 표시

### 2.3 게이트 표현

#### 2.3.1 게이트 외형
```
    입력 포트      출력 포트
        ↓            ↓
    ○─┐          
    ○─┤ NOT ├─○
    ○─┘          
```

#### 2.3.2 상태별 표현
- **기본**: 회색 배경, 검은 테두리
- **호버**: 밝은 회색 배경
- **선택됨**: 노란색 테두리 (2px)
- **활성**: 파란색 글로우 효과 (신호 처리중)

## 3. 기능 상세

### 3.1 게이트 배치 기능

#### 3.1.1 배치 플로우
```mermaid
[팔레트 클릭] → [배치 모드] → [마우스 이동] → [프리뷰 표시] 
                                                      ↓
[ESC/우클릭] ← [모드 해제] ← [배치 완료] ← [좌클릭]
```

#### 3.1.2 배치 규칙
- 그리드 정렬: 자동으로 가장 가까운 그리드 칸에 스냅
- 단일 점유: 한 칸에는 하나의 개체만 배치 가능
- 경계 제한: 그리드 범위 내에서만 배치 가능

#### 3.1.3 연속 배치
- Shift 키 유지: 연속 배치 모드 (여러 개 배치)
- 일반 클릭: 단일 배치 후 모드 해제

### 3.2 게이트 선택 기능

#### 3.2.1 선택 방법
1. **단일 선택**: 게이트 클릭
2. **다중 선택**: Ctrl + 클릭 (향후 구현)
3. **범위 선택**: 드래그 선택 (향후 구현)

#### 3.2.2 선택 피드백
- 즉시 노란색 테두리 표시
- 속성 패널에 게이트 정보 표시
- 상태바에 "게이트 선택됨" 메시지

### 3.3 게이트 삭제 기능

#### 3.3.1 삭제 방법
| 방법 | 조작 | 설명 |
|------|------|------|
| 키보드 | Delete/Backspace | 선택된 게이트 삭제 |
| 컨텍스트 메뉴 | 우클릭 → "삭제" | 해당 게이트 삭제 |
| 삭제 모드 | D키 → 클릭 | 클릭한 게이트 즉시 삭제 |

#### 3.3.2 삭제 처리
1. 게이트 제거
2. 연결된 와이어 자동 제거
3. 그리드 점유 해제
4. 메모리 정리

#### 3.3.3 삭제 제한
- 입력/출력 노드는 삭제 불가
- 실행 중인 회로의 게이트는 경고 표시

### 3.4 유효성 검사

#### 3.4.1 검사 시점
- 실시간: 마우스 이동시 즉시 검사
- 배치 시도: 클릭시 최종 검사

#### 3.4.2 검사 항목
```cpp
bool IsValidPlacement(Vec2i gridPos) {
    return IsWithinBounds(gridPos) &&     // 경계 내
           !IsOccupied(gridPos) &&         // 비어있음
           !HasWireConflict(gridPos);      // 와이어 충돌 없음
}
```

#### 3.4.3 에러 처리
| 에러 유형 | 시각적 피드백 | 메시지 |
|-----------|--------------|---------|
| 경계 초과 | 빨간 X | "그리드 범위를 벗어났습니다" |
| 칸 점유 | 빨간 오버레이 | "이미 점유된 위치입니다" |
| 와이어 충돌 | 주황 경고 | "와이어와 충돌합니다" |

## 4. 시스템 동작

### 4.1 데이터 흐름

```
사용자 입력 → InputManager → PlacementSystem → Circuit
                                    ↓
                            ValidationSystem
                                    ↓
UI 피드백 ← RenderSystem ← GateRenderer
```

### 4.2 상태 관리

#### 4.2.1 PlacementSystem 상태
```cpp
enum class PlacementState {
    Idle,           // 대기 상태
    Placing,        // 배치 모드
    Selecting,      // 선택 모드
    Deleting        // 삭제 모드
};
```

#### 4.2.2 상태 전이
```
Idle ─[팔레트 클릭]→ Placing
Placing ─[좌클릭]→ Idle
Placing ─[ESC]→ Idle
Idle ─[게이트 클릭]→ Selecting
Selecting ─[빈공간 클릭]→ Idle
Idle ─[D키]→ Deleting
Deleting ─[ESC]→ Idle
```

### 4.3 이벤트 처리

#### 4.3.1 마우스 이벤트
```cpp
void OnMouseMove(Vec2 screenPos) {
    Vec2i gridPos = ScreenToGrid(screenPos);
    UpdatePreview(gridPos);
    UpdateValidation(gridPos);
}

void OnMouseClick(MouseButton button, Vec2 screenPos) {
    if (button == LEFT) {
        if (state == Placing) PlaceGate();
        else if (state == Idle) SelectGate();
    }
    else if (button == RIGHT) {
        ShowContextMenu();
    }
}
```

#### 4.3.2 키보드 이벤트
| 키 | 기능 | 조건 |
|----|------|------|
| N | NOT 게이트 선택 | 언제나 |
| Delete | 게이트 삭제 | 게이트 선택시 |
| D | 삭제 모드 토글 | Idle 상태 |
| ESC | 현재 모드 취소 | 모든 모드 |
| Shift | 연속 배치 모드 | Placing 상태 |

## 5. 성능 사양

### 5.1 응답 시간
- 마우스 이동 → 프리뷰 업데이트: < 16ms (60 FPS)
- 클릭 → 게이트 배치: < 10ms
- 유효성 검사: < 1ms

### 5.2 메모리 사용
- 게이트당 메모리: ~64 bytes
- 최대 게이트 수: 10,000 (일반), 1,000,000 (샌드박스)
- 게이트 풀 사전 할당: 1,000개 단위

### 5.3 렌더링 성능
- 배치 드로우 콜: 모든 게이트 1회
- 컬링: 뷰포트 외부 게이트 제외
- LOD: 줌 레벨에 따른 디테일 조절

## 6. 오류 처리

### 6.1 사용자 오류
| 오류 | 처리 | 피드백 |
|------|------|---------|
| 잘못된 위치 클릭 | 배치 무시 | 빨간색 플래시 |
| 메모리 부족 | 배치 실패 | 경고 다이얼로그 |
| 최대 게이트 초과 | 배치 제한 | "최대 게이트 수 도달" |

### 6.2 시스템 오류
- ID 충돌: 자동 재생성
- 렌더링 실패: 폴백 렌더러 사용
- 메모리 할당 실패: 긴급 가비지 컬렉션

## 7. 확장성

### 7.1 향후 추가 기능
- 다른 게이트 타입 (AND, OR, XOR)
- 그룹 선택 및 이동
- 복사/붙여넣기
- 실행 취소/다시 실행
- 게이트 회전

### 7.2 인터페이스 확장점
```cpp
class IGatePlacer {
    virtual bool CanPlace(Vec2i pos) = 0;
    virtual void Place(Vec2i pos) = 0;
    virtual void Remove(uint32_t id) = 0;
};
```

## 8. 테스트 시나리오

### 8.1 기본 기능 테스트
1. 팔레트에서 NOT 게이트 선택
2. 빈 그리드 칸에 배치
3. 배치된 게이트 클릭하여 선택
4. Delete 키로 삭제
5. 결과: 게이트가 정상적으로 배치/선택/삭제됨

### 8.2 에지 케이스 테스트
1. 그리드 경계에 배치 시도
2. 이미 점유된 칸에 배치 시도
3. 1000개 게이트 연속 배치
4. 빠른 클릭으로 중복 배치 시도
5. 결과: 모든 경우 정상 처리 및 적절한 피드백

### 8.3 성능 테스트
1. 10,000개 게이트 배치
2. 전체 화면 패닝
3. 최대 줌 인/아웃
4. 결과: 60 FPS 유지

## 9. 사용자 경험 가이드라인

### 9.1 직관성
- 드래그 앤 드롭 메타포 사용
- 실시간 시각적 피드백
- 명확한 에러 메시지

### 9.2 효율성
- 단축키 지원
- 연속 배치 모드
- 빠른 삭제 옵션

### 9.3 학습 곡선
- 툴팁으로 기능 설명
- 첫 사용시 힌트 표시
- 실수 복구 용이

## 10. 구현 체크리스트

### Phase 1: 기본 구현
- [ ] UIManager에 팔레트 UI 추가
- [ ] PlacementSystem 클래스 생성
- [ ] 기본 배치 로직 구현
- [ ] 그리드 점유 관리 구현

### Phase 2: 상호작용
- [ ] 마우스 이벤트 처리
- [ ] 키보드 단축키 구현
- [ ] 선택/하이라이트 시스템
- [ ] 삭제 기능 구현

### Phase 3: 시각화
- [ ] 프리뷰 렌더링
- [ ] 유효성 피드백 표시
- [ ] 선택 하이라이트
- [ ] 애니메이션 효과

### Phase 4: 최적화
- [ ] 메모리 풀 구현
- [ ] 렌더링 배칭
- [ ] 뷰포트 컬링
- [ ] 성능 프로파일링