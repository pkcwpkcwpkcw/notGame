# Step 5: 게이트 배치 시스템 요구사항 명세서

## 개요
Step 5는 NOT 게이트를 그리드에 배치하고 관리하는 핵심 시스템을 구현합니다. 사용자가 게이트를 선택하고, 배치하고, 삭제할 수 있는 인터랙티브한 편집 기능을 제공합니다.

## 세부 요구사항

### 5.1 NOT 게이트 팔레트 UI

#### 기능 요구사항
- ImGui 도킹 윈도우로 구현 (왼쪽 또는 오른쪽 사이드바)
- NOT 게이트 아이콘/버튼 표시
- 클릭시 게이트 선택 모드 활성화
- 선택된 게이트 타입 시각적 피드백 (하이라이트, 테두리 등)

#### 기술 구현
```cpp
// UIManager 클래스에 추가
class UIManager {
    enum class PlacementMode {
        None,
        NotGate,
        Wire  // 향후 확장용
    };
    
    PlacementMode currentMode;
    void RenderGatePalette();  // ImGui 팔레트 렌더링
};
```

#### UI 레이아웃
- 팔레트 크기: 200px 너비
- NOT 게이트 버튼: 64x64px
- 툴팁: 마우스 호버시 "NOT Gate (반전)"
- 단축키: 'N' 키로 빠른 선택

### 5.2 게이트 선택 상태

#### 상태 관리
- 현재 선택 모드 (None/PlaceGate/SelectGate)
- 선택된 게이트 ID (편집/삭제용)
- 배치 프리뷰 좌표

#### 시각적 피드백
- 배치 모드: 마우스 커서에 반투명 게이트 프리뷰
- 선택 모드: 선택된 게이트 하이라이트 (노란색 테두리)
- 유효하지 않은 위치: 빨간색 오버레이

#### 상태 전환
```
None -> (팔레트 클릭) -> PlaceGate
PlaceGate -> (ESC 또는 우클릭) -> None
PlaceGate -> (좌클릭 배치) -> None
None -> (게이트 클릭) -> SelectGate
SelectGate -> (빈 공간 클릭) -> None
```

### 5.3 그리드에 게이트 배치

#### 배치 프로세스
1. 마우스 위치를 그리드 좌표로 변환 (Step 4에서 구현됨)
2. 해당 좌표의 유효성 검사
3. Circuit 클래스에 게이트 추가
4. 그리드 맵 업데이트
5. 렌더링 업데이트

#### 데이터 구조
```cpp
class Circuit {
    // 게이트 추가
    uint32_t AddGate(GateType type, Vec2i gridPos);
    
    // 그리드 점유 관리
    std::unordered_map<Vec2i, uint32_t> gridOccupancy;
};
```

#### 게이트 속성
- ID: 고유 식별자 (자동 생성)
- 타입: NOT (현재는 하나만)
- 위치: 그리드 좌표 (Vec2i)
- 입력 포트: 3개 (왼쪽)
- 출력 포트: 1개 (오른쪽)

### 5.4 게이트 위치 유효성 검사

#### 검사 항목
1. **경계 검사**: 그리드 범위 내인가?
2. **점유 검사**: 해당 칸이 비어있는가?
3. **연결 검사**: 기존 와이어와 충돌하지 않는가?

#### 구현
```cpp
bool Circuit::CanPlaceGate(Vec2i pos) {
    // 1. 경계 검사
    if (pos.x < 0 || pos.x >= gridWidth || 
        pos.y < 0 || pos.y >= gridHeight) {
        return false;
    }
    
    // 2. 점유 검사
    if (gridOccupancy.find(pos) != gridOccupancy.end()) {
        return false;
    }
    
    // 3. 와이어 충돌 검사 (향후 구현)
    return true;
}
```

#### 에러 피드백
- 시각적: 빨간색 X 표시 또는 반투명 빨간 오버레이
- 사운드: 배치 실패 효과음 (옵션)
- 텍스트: 상태바에 실패 이유 표시

### 5.5 게이트 삭제 기능

#### 삭제 방법
1. **선택 후 삭제**: 게이트 클릭 → Delete 키
2. **우클릭 메뉴**: 게이트 우클릭 → "삭제" 선택
3. **삭제 모드**: 'D' 키로 삭제 모드 진입 → 클릭으로 삭제

#### 삭제 프로세스
1. 선택된 게이트 확인
2. 연결된 와이어 확인 및 경고
3. 게이트 제거
4. 연결된 와이어 자동 제거
5. 그리드 맵 업데이트
6. 렌더링 업데이트

#### 안전장치
- 실행 취소 기능 (Ctrl+Z) - 향후 구현
- 삭제 확인 다이얼로그 (10개 이상 연결시)
- 입력/출력 노드는 삭제 불가

## 성능 고려사항

### 메모리 관리
- 게이트 풀: 미리 할당된 게이트 배열 사용
- 최대 게이트 수: 일반 모드 10,000개, 샌드박스 1,000,000개
- ID 재사용: 삭제된 게이트 ID 재활용

### 렌더링 최적화
- 더티 플래그: 변경된 부분만 재렌더링
- 뷰포트 컬링: 보이는 게이트만 렌더링
- 배치 렌더링: 모든 게이트를 하나의 드로우 콜로

## 테스트 요구사항

### 단위 테스트
1. 게이트 배치 유효성 검사
2. ID 생성 및 고유성
3. 그리드 점유 관리
4. 삭제 후 메모리 정리

### 통합 테스트
1. 팔레트 UI와 배치 시스템 연동
2. 마우스 입력과 게이트 배치
3. 여러 게이트 연속 배치
4. 삭제 후 재배치

### 사용자 테스트
1. 직관적인 배치 과정
2. 시각적 피드백 명확성
3. 실수 복구 용이성
4. 성능 (1000개 게이트 배치시 60 FPS)

## 구현 우선순위

### 필수 (MVP)
1. 기본 팔레트 UI
2. 게이트 배치 기능
3. 위치 유효성 검사
4. 간단한 삭제 (선택 후 Delete)

### 중요
1. 배치 프리뷰
2. 선택 상태 시각화
3. 우클릭 컨텍스트 메뉴

### 선택
1. 단축키 시스템
2. 삭제 모드
3. 툴팁 및 도움말

## 파일 구조

```
src/
├── ui/
│   ├── UIManager.cpp       # 팔레트 UI 구현
│   └── GatePalette.cpp     # 게이트 팔레트 전용
├── game/
│   ├── PlacementSystem.cpp # 배치 로직
│   └── SelectionSystem.cpp # 선택/삭제 로직
├── core/
│   └── Circuit.cpp         # AddGate, RemoveGate 구현
└── render/
    └── GateRenderer.cpp    # 프리뷰, 하이라이트 렌더링
```

## 예상 일정

- 5.1 팔레트 UI: 2시간
- 5.2 선택 상태: 1시간
- 5.3 배치 시스템: 3시간
- 5.4 유효성 검사: 1시간
- 5.5 삭제 기능: 2시간
- 테스트 및 디버깅: 2시간

**총 예상 시간: 11시간**

## 완료 기준

- [ ] NOT 게이트 팔레트가 표시되고 클릭 가능
- [ ] 게이트를 그리드에 배치 가능
- [ ] 중복 배치 방지
- [ ] 게이트 선택 및 하이라이트
- [ ] Delete 키로 선택된 게이트 삭제
- [ ] 60 FPS 유지 (100개 게이트 기준)

## 다음 단계 연동

Step 6 (와이어 연결 시스템)을 위한 준비:
- 게이트 포트 위치 계산 함수
- 게이트 ID로 빠른 조회
- 포트 연결 정보 저장 구조

## 참고사항

- 게이트 크기: 그리드 1칸 (32x32 픽셀)
- 포트 위치: 입력(왼쪽 3개), 출력(오른쪽 1개)
- 색상: 기본(회색), 선택(노란 테두리), 활성(파란색)
- 애니메이션: 배치시 페이드인 효과 (선택사항)